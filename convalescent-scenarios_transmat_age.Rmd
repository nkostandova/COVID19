---
title: "convalescent plasma models"
author: "Natalya Kostandova"
date: "5/24/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
require(IDDynamicsClass)
library(deSolve)
library(truncnorm)
library(knitr)
library(kableExtra)
library(ggplot2)
library(dplyr)
library(tidyr)
library(truncnorm)
library(socialmixr)
```

# Model 1. 

Assume the following compartmental model.

```{r, echo=FALSE, out.width = "70%"}
knitr::include_graphics("scenario1.png")
```

The $S$ compartment is susceptibles; here, we assume that it's composed of general public and a healthcare workers compartment. The healthcare workers are assumed to have a higher number of contacts than the general public. $E$ is the exposed compartment. Infectious individuals are supposed to be split between $I_A$ (infectious asymptomatic), $I_M$ (infectious with mild symptoms), and $I_S$ (infectious with severe symptoms). $R$ is the recovered compartment. Plasma can be given to the susceptible population, in which case indivudals move to $S_T$ compartment; to exposed individuals as post-exposure prophylaxis (with individuals moving from $E$ to $E_T$ compartment), and to infectious people, who would then move to either $I_{AT}$, $I_{MT}$, or $I_{ST}$ compartment, depending on the compartment of origin. Note that because only a portion of plasma is "effective" (has a level of titer that's high enough), some individuals will remain in the  untreated compartment even if they received plasma.  

We expect excess mortality due to COVID; it is assumed to only occur among severe cases ($I_S$). Excess mortality among infectious treated individuals with severe presentation is expected to be reduced.    
P represents the plasma compartments (number of units of plasma available at a given time).

## Population and Contact matrix

We assume population consisting of general public and health care workers.
We assume increased contacts for healthcare workers. 

Here, we use population structure for Washington DC, with age groups broken up in 0-19 years old, 20-44 years old, 45-54 years old, 55-74 years old, and 75 and greater years old. In addition, we have a healthcare worker compartment and a homeless compartment, with an estimated 6,000 healthcare workers. We set homeless compartment to 1 for the purposes of this simulation (essentially 0).  

The contact matrix used is from Polymod for UK; contacts for healthcare workers and individuals experiencing homelessness are assumed to be the same as for the 45-54 year old category.


```{r, echo=FALSE}
# initialize population; use WASH DC population
# assume 6,000 healthcare workers and 0 individuals experiencing homelessness (put 1 to avoid any issues)
pop = c(103095, 322685, 75453, 119406, 36199, 6000, 1)

# get number of compartments
Ncomp = length(pop)


# set up polymod
age.limits = c(0, 20, 45, 55, 75)


make_polymod_matrix <- function(age.limits, hcw.mix="45,55", hml.mix="45,55"){
  data(polymod)
  age_mix <- contact_matrix(polymod, countries="United Kingdom", age.limits = age.limits)$matrix
  
  # assume same mixing for homeless and healthcare workers as 45-55 year olds
  W <- matrix(NA,nrow(age_mix)+2, ncol(age_mix)+2)
  rownames(W) <- c(rownames(age_mix), 'healthcare', 'homeless') 
  colnames(W) <- c(colnames(age_mix), 'healthcare', 'homeless')
  W[1:nrow(age_mix),1:ncol(age_mix)] <- age_mix
  
  W[nrow(age_mix)+1,] = W[grep(hcw.mix, rownames(W)),] ## healthcare
  W[nrow(age_mix)+2,] = W[grep(hml.mix, rownames(W)),] ## homeless
  W[,nrow(age_mix)+1] = W[,grep(hcw.mix, rownames(W))] ## healthcare
  W[,nrow(age_mix)+2] = W[,grep(hml.mix, rownames(W))] ## homeless
  return(W)
}


# rescale the mixing matrix so that the maximum eigenvalue is 1
rescale_age_matrix <- function(Ncomp, W, pop, c_scale_vec){
  A <- matrix(0,Ncomp,Ncomp) 
  for (ii in 1:Ncomp){
    for (jj in 1:Ncomp){
      A[ii, jj] = W[ii, jj]*pop[ii] / pop[jj]
    }
  }
  
  r = eigen(A)
  lam = r$values
  alpha = max(Re(lam))
  W = W / alpha
  
  C <- matrix(c_scale_vec,nrow(W),ncol(W)) ## a special contact matrix to be used to rescale health facility worker contact rates - when set to 1, it is turned off
  return(list(W = W, C = C))
}

```


## Set up the SEAIR model




Initial conditions and assumptions are as follows:
  

-Everybody in the population is susceptible    
-15 people infected in general population (1 in each compartment for asymptomatic, mild, and severe); 0 in healthcare workers  
-R0 = 2.5  
-$\gamma$ = recovery rate = 1 / (6.5days)  
-$\sigma$ = 1 / (5.2 days)  
-natural death rate = 0   
-birth rate = 0  
-mortality rate from infection = probability of death among hospitalized / (3*7), where 3 weeks = median number of days from symptoms to death

  
For plasma, we assume
-proportion of plasma that's functional (with high enough titer) is 70%  
-Among those susceptibles that receive functional plasma, transmission coefficient is reduced by 50%  
-$\gamma_t$ = 1 / 4 (duration of time to recovery is reduced from 6.5 days to 4 days)    
-mortality rate from infection for treated individuals is  = (half of mortality  for untreated people)    
-proportion of exposed individuals treated with effective plasma that move on to infected compartment is $prop_{ETI}$ = 0.1  
  


We set the following parameters:  
-p0 = number of units of plasma available at day 1 (default, 2000)
-$p_{use}$ = proportion of plasma available to be used (for example, not diverted towards hyperimmune globulin)  
-$p_s$ = proportion of plasma allocated to be administered to susceptible individuals  
-$p_e$ = proportion of plasma allocated to be administered to exposed individuals  
-$p_ia$ = proportion of plasma allocated to be administered to infected individuals (asymptomatic)  
-$p_im$ = proportion of plasma allocated to be administered to infected individuals (mild)  
-$p_is$ = proportion of plasma allocated to be administered to infected individuals (severe)  
-$rate_p$ = rate at which plasma is donated; assumed to be 3.5 units / 14 days (assuming each person that donates gives 3.5 units)  
-$p_{give}$ = proportion of recovered individuals that give plasma (default: 0.1)

We assume that all individuals in exposed compartment will move to either asymptomatic, mild, or severe compartments. We assume that there is no excess death from COVID-19 in either asymptomatic or mild individuals. Probability of becoming symptomatic and progressing to severe disease is based on CDC data, assuming 2% mortality [CDC](https://www.cdc.gov/mmwr/volumes/69/wr/mm6912e2.htm#T1_down). 
  
We assume rates of recovery to be the same from the three levels of different severity.  




```{r, echo=FALSE}

### set up SEIR function (get W and C matrices, as well as probabilities for asymptomatic, mild, and severe infections)

setup_seir_age = function(c_scale_vec=1, prop_sym, p_hosp, hcw.mix="45,55", hml.mix="45,55", 
                          pop = pop_data, age.limits = c(0, 20, 45, 55, 75)){
  pop = pop_data
  Ncomp = length(pop)
  W <- make_polymod_matrix(age.limits, hcw.mix = hcw.mix, hml.mix = hml.mix)
  rescale_mixing <- rescale_age_matrix(Ncomp, W, pop, c_scale_vec)
  W <- rescale_mixing$W
  C <- rescale_mixing$C
  
  # set up initial conditions
  
  InCs <- c(S = pop, 
            St = rep(0, Ncomp),
            E = rep(0, Ncomp),
            Et = rep(0, Ncomp),
            A = c(rep(1, Ncomp-1), 0),   ### for now, assign 0 infected to homeless compartment because we have no homeless population
            At = rep(0, Ncomp),
            Im = c(rep(1, Ncomp-1), 0), 
            Imt = rep(0, Ncomp),
            Is = c(rep(1, Ncomp-1), 0), 
            Ist = rep(0, Ncomp),
            R = rep(0, Ncomp),
            incid_deaths = rep(0, Ncomp),
            incid_A = rep(0, Ncomp),
            incid_Im = rep(0, Ncomp),
            incid_Is = rep(0, Ncomp),
            incid_plasma = rep(0, Ncomp))
  
  
  # 2% death rate data from CDC 
  symptomatic_2<- c(123,705,429,838,354,429,429)
  hosp_2<- c(3.08,146.64,121.41,307.05,224.5,121.41,121.41)
  
  num_sym = symptomatic_2
  p_hosp = hosp_2 / symptomatic_2
  
  prop_sym = num_sym / 1000
  p_asym = 1 - prop_sym    # proportion asymptomatic
  p_severe = prop_sym * p_hosp # proportion severe
  p_mild = prop_sym * (1-p_hosp) # proportion mild
  
  
  #ICU_2<-c(0,29.61,44.62,124.94,106.86,44.62,44.62)
dead_ICU_2<- c(0, 0.58,1.465,11.095,16.435,1.465,1.465)
  p_death = dead_ICU_2 / hosp_2
  
  
  return(list(W = W, C = C, ICs = InCs, Ncomp = Ncomp,
              p_asym = p_asym, p_severe = p_severe, p_mild = p_mild,
              p_death = p_death))
}


```


<!--
```{r, echo=FALSE}
seir_step_age = function(stoch.init = FALSE, stoch = TRUE, Ncomp = Ncomp, ICs = InCs, sd.dw = 0.00, 
                     params = parameters, plasma = plasma_params, 
                     SIA_r = SIA_rates,
                     init.min = 10, init.max = 100) {
  
C = params$C
W = params$W

   
  N = params$N

  beta = params$beta
  gamma = params$gamma
  sigma = params$sigma
  time = params$time
  delta.t = params$delta.t
  v = params$v
  mu = params$mu
  v_I = params$v_I
  
  p_asym = params$p_asym
  p_severe = params$p_severe
  p_mild = params$p_mild
  
  gamma_t = plasma$gamma_t
  prop_ef = plasma$prop_ef
  ef_est = plasma$ef_est
  prop_eti = plasma$prop_eti
  SIA_s = SIA_r$SIA_s
  SIA_e = SIA_r$SIA_e
  SIA_ia = SIA_r$SIA_ia
  SIA_im = SIA_r$SIA_im
  SIA_is = SIA_r$SIA_is
  
  p0 = plasma$p0
  p_s = plasma$p_s
  p_e = plasma$p_e
  p_ia = plasma$p_ia
  p_im = plasma$p_im
  p_is = plasma$p_is
  p_use = plasma$p_use
  rate_p = plasma$rate_p
  p_give = plasma$p_give
  
  # set up matrix to store values
  x = matrix(NA, nrow = length(time), ncol = Ncomp * length(ICs))
  x[1, ]=round(ICs)
  
  # set initial conditions
  if(stoch.init==TRUE){
    Ninit = sample(init.min:init.max, 1)
    pinit = N / sum(N)
    Ninit_bygroup = rmultinom(1, Ninit, prob = pinit)[,1]
    Ninit_asy = Ninit_bygroup * p_asym
    Ninit_mild = Ninit_bygroup * p_mild
    Ninit_severe = Ninit_bygroup * p_severe
    ICs = c(S = N,           
            E = rep(0, Ncomp),
            A = Ninit_asy,
            Im = Ninit_mild,
            Is = Ninit_severe,
            R = rep(0, Ncomp),
            incid_I = rep(0, Ncomp),
            incid_deaths = rep(0, Ncomp),
            incid_plasma = rep(0, Ncomp))
    x[1,] <- round(ICs)
  }else{ x[1,] <- round(ICs) }
  
  S = x[, 1:Ncomp] 
  St = x[, (Ncomp+1):(2*Ncomp)]
  E = x[, (2*Ncomp+1):(3*Ncomp)] 
  Et = x[, (3*Ncomp+1):(4*Ncomp)]
  A = x[, (4*Ncomp+1):(5*Ncomp)]
  At = x[, (5*Ncomp+1):(6*Ncomp)]
  Im = x[, (6*Ncomp+1):(7*Ncomp)]
  Imt = x[, (7*Ncomp+1):(8*Ncomp)]
  Is = x[, (8*Ncomp+1):(9*Ncomp)]
  Ist = x[, (9*Ncomp+1):(10*Ncomp)]
  R =  x[, (10*Ncomp+1):(11*Ncomp)]
  
  P = matrix(NA, nrow = length(time), ncol = 1)
  P[1, 1] = p0
  
  # incidence
  incid_A = x[, (11*Ncomp+1):(12*Ncomp)]
  incid_Im = x[, (12*Ncomp+1):(13*Ncomp)]
  incid_Is = x[, (13*Ncomp+1):(14*Ncomp)]
  incid_deaths = x[, (14*Ncomp+1):(15*Ncomp)]
  incid_plasma = x[, (15*Ncomp+1):(16*Ncomp)]
  
  sd.dw = sd.dw
  
  
  
   out = matrix(NA, nrow = length(time), ncol = Ncomp * 11 + 5*Ncomp + 1 )
  
  for (it in 1:(length(time) - 1)) {
    
     
  nt = rbind(S[it, ], St[it,], E[it, ], Et[it, ], A[it, ], At[it,], Im[it,], Imt[it,], Is[it,], Ist[it,], R[it,])
  
   # 5 = number of variables in incid matrix; 1 = plasma
  temp = cbind(S[1,], St[1,], E[1,], Et[1,], A[1,], At[1,], Im[1,], Imt[1,], Is[1,], Ist[1,], R[1,], incid_A[1,], incid_Im[1,], incid_Is[1,], incid_deaths[1,], incid_plasma[1,])
  temp2 =  as.vector(temp)
  temp2 = as.vector(c(temp2,P[1,]))
  out[1,] = temp2
  names(out) = c(names(ICs), "plasma_units")
  
    WI = (C*W) %*% (A[it,]+At[it,]+Im[it,]+Imt[it,]+Is[it,]+Ist[it,])
    births = rep(0, Ncomp)
    births[1] = mu
    deaths = rep(v, Ncomp)
    ######### GOING TO NEED TO UPDATE DEATHS FROM COVID ---- age and severity (ICU / non-ICU)
    deaths_I = rep(v_I, Ncomp)
    deaths_It = rep(v_It, Ncomp)
    
    dw = rtruncnorm(Ncomp, a =0, mean = 1, sd = sd.dw)
    
    # transitions
    foi_prob <- 1 - exp( - beta* WI / N * dw * delta.t)
    exposed_prob <- 1 - exp( - sigma * delta.t)    
    inf_prob <- 1 - exp( - gamma * delta.t)   
    death_prob <- 1 - exp( - deaths * delta.t)
    death_prob_I <- 1 - exp( - deaths_I * delta.t)
    inf_prob_t <- 1 - exp(- gamma_t * delta.t * (1-prop_eti))
    inf_prob_et <- 1 - exp( - sigma * delta.t * prop_eti)
    death_prob_It <- 1 - exp( - deaths_It * delta.t)
    foi_prob_St <- 1 - exp( - ef_est * beta* WI / N * dw * delta.t)
    #exposed_prob_t <- 1 - exp( - sigma * delta.t * ef_est)   
    
    new_St = rep(NA, Ncomp)
    for(i in (1:Ncomp)){
      new_St[i] = ifelse(P[it] * p_use * p_s[i] + SIA_s[it, i]>S[it,i],  S[it, i] * prop_ef, P[it] * p_use * p_s[i] * prop_ef + SIA_s[it, i] * prop_ef)
    }
    p_St = ifelse(new_St == 0, 0, new_St / S[it, ])
    
    new_Et = rep(NA, Ncomp)
    for(i in (1:Ncomp)){
      new_Et[i] = ifelse(P[it] * p_use * p_e[i] + SIA_e[it, i]>E[it,i],  E[it, i] * prop_ef, P[it] * p_use * p_e[i] * prop_ef + SIA_e[it, i] * prop_ef)
    }      
    p_Et = ifelse(new_Et ==0, 0, new_Et / E[it, ])
    
    new_Iat = rep(NA, Ncomp)
    for(i in (1:Ncomp)){
      new_Iat[i] = ifelse(P[it] * p_use * p_ia[i] + SIA_ia[it, i]>A[it,i],  A[it, i] * prop_ef, P[it] * p_use * p_ia[i] * prop_ef + SIA_ia[it, i] * prop_ef)
    } 
    p_Iat = ifelse(new_Iat ==0, 0, new_Iat / A[it, ])
    
    new_Imt = rep(NA, Ncomp)
    for(i in (1:Ncomp)){
      new_Imt[i] = ifelse(P[it] * p_use * p_im[i] + SIA_im[it, i]>Im[it,i],  Im[it, i] * prop_ef, P[it] * p_use * p_im[i] * prop_ef + SIA_im[it, i] * prop_ef)
    }  
    p_Imt = ifelse(new_Imt ==0, 0, new_Imt / Im[it, ])
    
    new_Ist = rep(NA, Ncomp)
    for(i in (1:Ncomp)){
      new_Ist[i] = ifelse(P[it] * p_use * p_is[i] + SIA_is[it, i]>Is[it,i],  Is[it, i] * prop_ef, P[it] * p_use * p_is[i] * prop_ef + SIA_is[it, i] * prop_ef)
    }  
    p_Ist = ifelse(new_Ist ==0, 0, new_Ist / Is[it, ])
    
    
    ## set up a transition matrix A
    nt = rbind(S[it, ], St[it,], E[it, ], Et[it, ], A[it, ], At[it,], Im[it,], Imt[it,], Is[it,], Ist[it,], R[it,])
    Tm = matrix(NA, nrow = dim(nt)[1], ncol = Ncomp * (dim(nt)[1]+1)) ## add one for deaths
    z = rep(0, Ncomp)
    
    # transitions out of S compartment
    Tm[1,] = c(1-p_St-t(foi_prob), p_St, t(foi_prob), z, z, z, z, z, z, z, z, z)
    # transitions out of St compartment
    Tm[2,] = c(z, 1-t(foi_prob_St), t(foi_prob_St), z, z, z, z, z, z, z, z, z)
    # transitions out of E compartment
    Tm[3,] = c(z, z, 1-p_Et-exposed_prob, p_Et, exposed_prob*p_asym, z, exposed_prob*p_mild, z, exposed_prob*p_severe, z, z, z)
    # transitions out of Et compartment
    Tm[4,] = c(z, z, z, 1-inf_prob_et-inf_prob_t, inf_prob_et*p_asym, z, inf_prob_et*p_mild, z, inf_prob_et*p_severe, z, inf_prob_t, z)
    # transitions out of Ia compartment
    Tm[5,] = c(z, z, z, z, 1-p_Iat-inf_prob, p_Iat, z, z, z, z, inf_prob, z)
    # transitions out of Iat compartment
    Tm[6,] = c(z, z, z, z, z, 1-inf_prob_t, z, z, z, z, inf_prob_t, z)
    # transitions out of Im compartment
    Tm[7,] = c(z, z, z, z, z, z, 1-p_Imt-inf_prob, p_Imt, z, z, inf_prob, z)
    # transitions out of Imt compartment
    Tm[8,] = c(z, z, z, z, z, z, z, 1-inf_prob_t, z, z, inf_prob_t, z)
    # transitions out of Is compartment
    Tm[9,] = c(z, z, z, z, z, z, z, z, 1-p_Ist-inf_prob-death_prob_I, p_Ist, inf_prob, death_prob_I)
    # transitions out of Ist compartment
    Tm[10,] = c(z, z, z, z, z, z, z, z, z, 1-inf_prob_t-death_prob_It, inf_prob_t, death_prob_It)
    # transitions out of R compartment
    Tm[11,] = c(z, z, z, z, z, z, z, z, z, z, 1-z, z)
    
    
    if(stoch==TRUE){
      # do multinomial draws
      nstates = dim(nt)[1]+1
      Tm = data.frame(Tm)
      TmN = matrix(NA, nrow=nstates, ncol=Ncomp*(nstates))
      ntp1 = matrix(NA, nrow = nstates, ncol = Ncomp)
      incid = matrix(NA, nrow = 5, ncol=Ncomp)
      ntp = matrix(NA, nrow = nrow(ntp1)+nrow(incid), ncol = Ncomp)
      for (i in 1:Ncomp){
        # separate into matrices for each compartment
        Tm_i = Tm[, seq(i, ncol(Tm), Ncomp)]
        # draw multinomial draws
        TmN_i = matrix(NA, nrow = nstates-1, ncol = nstates)
        for (j in 1:nrow(TmN_i)){
          size = nt[j, i]
          TmN_i[j,] = rmultinom(1, size, prob = Tm_i[j,])
          
        }
        ntp1[,i] = t(colSums(TmN_i))
        incid[1,i] = sum(TmN_i[,5])-TmN_i[5,5] # incid_A
        incid[2,i] = sum(TmN_i[,7])-TmN_i[7,7] # incid_Im
        incid[3,i] = sum(TmN_i[,9])-TmN_i[9,9] # incid_Is
        #incid[4,i] = nt[9,i]-TmN_i[9,10]-TmN_i[9,11]-TmN_i[9,9]+
        #  nt[10,i]-TmN_i[10,11]-TmN_i[10,10]  #incid_deaths
        incid[4,i] = sum(TmN_i[,12])
        incid[5,i] = sum(TmN_i[,2])-TmN_i[2,2]+sum(TmN_i[,4])-TmN_i[4,4]+sum(TmN_i[,6])-TmN_i[6,6]+sum(TmN_i[,8])-TmN_i[8,8]+sum(TmN_i[,10])-TmN_i[10,10] #incid_plasma
        #ntp[1:nrow(ntp1),i] = ntp1[,i]
        #ntp[(nrow(ntp1)+1):nrow(ntp),i] = incid[,i]
      }
      ntp1=ntp1[-c(12),]
      ntp1_t = as.vector(t(ntp1))
      incid_t = as.vector(t(incid))
      
      P[it+1,] = P[it,] - sum(incid[5,]) + rbinom(n = 1, size = sum(ntp1[11,]), prob = p_give*rate_p)
      
      out[it+1,] = c(ntp1_t, incid_t, P[it+1,])
      
      S[it+1,] = out[it+1, 1:Ncomp] 
      St[it+1,] = out[it+1, (Ncomp+1):(2*Ncomp)]
      E[it+1,] = out[it+1, (2*Ncomp+1):(3*Ncomp)] 
      Et[it+1,] = out[it+1, (3*Ncomp+1):(4*Ncomp)]
      A[it+1,] = out[it+1, (4*Ncomp+1):(5*Ncomp)]
      At[it+1,] = out[it+1, (5*Ncomp+1):(6*Ncomp)]
      Im[it+1,] = out[it+1, (6*Ncomp+1):(7*Ncomp)]
      Imt[it+1,] = out[it+1, (7*Ncomp+1):(8*Ncomp)]
      Is[it+1,] = out[it+1, (8*Ncomp+1):(9*Ncomp)]
      Ist[it+1,] = out[it+1, (9*Ncomp+1):(10*Ncomp)]
      R[it+1,] =  out[it+1, (10*Ncomp+1):(11*Ncomp)]
      
      # incidence
      incid_A[it+1,] = out[it+1, (11*Ncomp+1):(12*Ncomp)]
      incid_Im[it+1,] = out[it+1, (12*Ncomp+1):(13*Ncomp)]
      incid_Is[it+1,] = out[it+1, (13*Ncomp+1):(14*Ncomp)]
      incid_deaths[it+1,] = out[it+1, (14*Ncomp+1):(15*Ncomp)]
      incid_plasma[it+1,] = out[it+1, (15*Ncomp+1):(16*Ncomp)]
      
      P[it+1,] = out[it+1, (16*Ncomp+1)]
    }
    

  }
  
  out2 = data.frame(cbind(time, S, St, E, Et, A, At, Im, Imt, Is, Ist, R, incid_A, incid_Im, incid_Is, incid_deaths, incid_plasma, P))
  names(out2) = c("time", names(ICs), "plasma_units")
  
  return(out2) 
}  

```
-->




```{r, echo=FALSE}
seir_step_age = function(stoch.init = FALSE, stoch = TRUE, Ncomp = Ncomp, ICs = InCs, sd.dw = 0.00, 
                         params = parameters, plasma = plasma_params, 
                         SIA_r = SIA_rates,
                         init.min = 10, init.max = 100) {
  
  C = params$C
  W = params$W
  
  
  N = params$N
  
  beta = params$beta
  gamma = params$gamma
  sigma = params$sigma
  time = params$time
  delta.t = params$delta.t
  v = params$v
  mu = params$mu
  v_I = params$v_I
  
  p_asym = params$p_asym
  p_severe = params$p_severe
  p_mild = params$p_mild
  
  gamma_t = plasma$gamma_t
  prop_ef = plasma$prop_ef
  ef_est = plasma$ef_est
  prop_eti = plasma$prop_eti
  SIA_s = SIA_r$SIA_s
  SIA_e = SIA_r$SIA_e
  SIA_ia = SIA_r$SIA_ia
  SIA_im = SIA_r$SIA_im
  SIA_is = SIA_r$SIA_is
  
  p0 = plasma$p0
  p_s = plasma$p_s
  p_e = plasma$p_e
  p_ia = plasma$p_ia
  p_im = plasma$p_im
  p_is = plasma$p_is
  p_use = plasma$p_use
  rate_p = plasma$rate_p
  p_give = plasma$p_give
  
  # set up matrix to store values
  x = matrix(NA, nrow = length(time), ncol = Ncomp * length(ICs))
  x[1, ]=round(ICs)
  
  # set initial conditions
  if(stoch.init==TRUE){
    Ninit = sample(init.min:init.max, 1)
    pinit = N / sum(N)
    Ninit_bygroup = rmultinom(1, Ninit, prob = pinit)[,1]
    Ninit_asy = Ninit_bygroup * p_asym
    Ninit_mild = Ninit_bygroup * p_mild
    Ninit_severe = Ninit_bygroup * p_severe
    ICs = c(S = N,           
            E = rep(0, Ncomp),
            A = Ninit_asy,
            Im = Ninit_mild,
            Is = Ninit_severe,
            R = rep(0, Ncomp),
            incid_I = rep(0, Ncomp),
            incid_deaths = rep(0, Ncomp),
            incid_plasma = rep(0, Ncomp))
    x[1,] <- round(ICs)
  }else{ x[1,] <- round(ICs) }
  
  S = x[, 1:Ncomp] 
  St = x[, (Ncomp+1):(2*Ncomp)]
  E = x[, (2*Ncomp+1):(3*Ncomp)] 
  Et = x[, (3*Ncomp+1):(4*Ncomp)]
  A = x[, (4*Ncomp+1):(5*Ncomp)]
  At = x[, (5*Ncomp+1):(6*Ncomp)]
  Im = x[, (6*Ncomp+1):(7*Ncomp)]
  Imt = x[, (7*Ncomp+1):(8*Ncomp)]
  Is = x[, (8*Ncomp+1):(9*Ncomp)]
  Ist = x[, (9*Ncomp+1):(10*Ncomp)]
  R =  x[, (10*Ncomp+1):(11*Ncomp)]
  
  P = matrix(NA, nrow = length(time), ncol = 1)
  P[1, 1] = p0
  
  # incidence
  incid_deaths = x[, (11*Ncomp+1):(12*Ncomp)]
  incid_A = x[, (12*Ncomp+1):(13*Ncomp)]
  incid_Im = x[, (13*Ncomp+1):(14*Ncomp)]
  incid_Is = x[, (14*Ncomp+1):(15*Ncomp)]
  incid_plasma = x[, (15*Ncomp+1):(16*Ncomp)]
  
  sd.dw = sd.dw
  
  
  
  out = matrix(NA, nrow = length(time), ncol = Ncomp * 11 + 5*Ncomp + 1 )
  
  for (it in 1:(length(time) - 1)) {
    
    
    nt = rbind(S[it, ], St[it,], E[it, ], Et[it, ], A[it, ], At[it,], Im[it,], Imt[it,], Is[it,], Ist[it,], R[it,])
    
    # 5 = number of variables in incid matrix; 1 = plasma
    temp = cbind(S[1,], St[1,], E[1,], Et[1,], A[1,], At[1,], Im[1,], Imt[1,], Is[1,], Ist[1,], R[1,], incid_deaths[1,], incid_A[1,], incid_Im[1,], incid_Is[1,], incid_plasma[1,])
    temp2 =  as.vector(temp)
    temp2 = as.vector(c(temp2,P[1,]))
    out[1,] = temp2
    names(out) = c(names(ICs), "plasma_units")
    
    WI = (C*W) %*% (A[it,]+At[it,]+Im[it,]+Imt[it,]+Is[it,]+Ist[it,])
    births = rep(0, Ncomp)
    births[1] = mu
    deaths = rep(v, Ncomp)
    ######### GOING TO NEED TO UPDATE DEATHS FROM COVID ---- age and severity (ICU / non-ICU)
    deaths_I = v_I
    deaths_It = v_It
    
    dw = rtruncnorm(Ncomp, a =0, mean = 1, sd = sd.dw)
    
    # transitions
    foi_prob <- 1 - exp( - beta* WI / N * dw * delta.t)
    exposed_prob <- 1 - exp( - sigma * delta.t)    
    inf_prob <- 1 - exp( - gamma * delta.t)   
    death_prob <- 1 - exp( - deaths * delta.t)
    death_prob_I <- 1 - exp( - deaths_I * delta.t)
    inf_prob_t <- 1 - exp(- gamma_t * delta.t * (1-prop_eti))
    inf_prob_et <- 1 - exp( - sigma * delta.t * prop_eti)
    death_prob_It <- 1 - exp( - deaths_It * delta.t)
    foi_prob_St <- 1 - exp( - ef_est * beta* WI / N * dw * delta.t)
    #exposed_prob_t <- 1 - exp( - sigma * delta.t * ef_est)   
    
    # replace any negative values with zeros
    foi_prob = replace(foi_prob, foi_prob<0, 0)
    exposed_prob = replace(exposed_prob, exposed_prob<0, 0)
    inf_prob = replace(inf_prob, inf_prob<0, 0)
    death_prob = replace(death_prob, death_prob<0, 0)
    death_prob_I = replace(death_prob_I, death_prob_I<0, 0)
    inf_prob_t = replace(inf_prob_t, inf_prob_t<0, 0)
    inf_prob_et = replace(inf_prob_et, inf_prob_et<0, 0)
    death_prob_It = replace(death_prob_It, death_prob_It<0, 0)
    foi_prob_St = replace(foi_prob_St, foi_prob_St<0, 0)
    
    # plasma allocation ---- CONSIDER HOW TO DO THIS NICELY. 
    # # 1. split between compartments based on multinomial draw
    # size = round(P[it,] *p_use)
    # probs_plasma = c(p_s, p_e, p_ia, p_im, p_is, 1-sum(p_s, p_e, p_ia, p_im, p_is))
    # n_plasma = rmultinom(1, size, prob = probs_plasma)
    # # 2. check whether any of the allocations are > number of individuals in those compartments
    # ind = c(S[it,], E[it,], A[it,], Im[it,], Is[it,])
    # camp = c(SIA_s[it,], SIA_e[it,], SIA_ia[it,], SIA_im[it,], SIA_is[it,])   ### campaign 
    # for (k in 1:length(ind)){
    #   n_plasma[k] = min(n_plasma[k]+camp[k], ind[k])
    # }
    # l = length(n_plasma)
    # n_plasma[l] = round(P[it,]*p_use)-sum(n_plasma[1:(length(n_plasma)-1)])
    # p_plasma = ifelse(ind==0, 0, n_plasma[1:(length(n_plasma)-1)] / ind)
    # 3. Take into account that a portion of administered plasma does not have high enough titers to be effective
    # p_eff_plasma = p_plasma * prop_ef      ### proportion of individuals that receive plasma that receive plasma with high enough titer and move on to the T compartment
    # p_St = p_eff_plasma[1:Ncomp]
    # p_Et = p_eff_plasma[(Ncomp+1): 2*Ncomp]
    # p_Iat = p_eff_plasma[(2*Ncomp+1): 3*Ncomp]
    # p_Imt = p_eff_plasma[(3*Ncomp+1): 4*Ncomp]
    # p_Ist = p_eff_plasma[(4*Ncomp+1): 5*Ncomp]
    
    ## previous version of plasma allocation-- need to check this
    new_St = rep(NA, Ncomp)
    for(i in (1:Ncomp)){
      new_St[i] = ifelse(P[it] * p_use * p_s[i] + SIA_s[it, i]>S[it,i],  S[it, i] * prop_ef, P[it] * p_use * p_s[i] * prop_ef + SIA_s[it, i] * prop_ef)
    }
    p_St = ifelse((new_St < 0 | S[it,]==0), 0, new_St / S[it, ])
    
    new_Et = rep(NA, Ncomp)
    for(i in (1:Ncomp)){
      new_Et[i] = ifelse(P[it] * p_use * p_e[i] + SIA_e[it, i]>E[it,i],  E[it, i] * prop_ef, P[it] * p_use * p_e[i] * prop_ef + SIA_e[it, i] * prop_ef)
    }      
    p_Et = ifelse((new_Et <0 | E[it,]==0), 0, new_Et / E[it, ])
    
    new_Iat = rep(NA, Ncomp)
    for(i in (1:Ncomp)){
      new_Iat[i] = ifelse(P[it] * p_use * p_ia[i] + SIA_ia[it, i]>A[it,i],  A[it, i] * prop_ef, P[it] * p_use * p_ia[i] * prop_ef + SIA_ia[it, i] * prop_ef)
    } 
    p_Iat = ifelse((new_Iat <0 | A[it,]==0), 0, new_Iat / A[it, ])
    
    new_Imt = rep(NA, Ncomp)
    for(i in (1:Ncomp)){
      new_Imt[i] = ifelse(P[it] * p_use * p_im[i] + SIA_im[it, i]>Im[it,i],  Im[it, i] * prop_ef, P[it] * p_use * p_im[i] * prop_ef + SIA_im[it, i] * prop_ef)
    }  
    p_Imt = ifelse((new_Imt <0 | Im[it,]==0), 0, new_Imt / Im[it, ])
    
    new_Ist = rep(NA, Ncomp)
    for(i in (1:Ncomp)){
      new_Ist[i] = ifelse(P[it] * p_use * p_is[i] + SIA_is[it, i]>Is[it,i],  Is[it, i] * prop_ef, P[it] * p_use * p_is[i] * prop_ef + SIA_is[it, i] * prop_ef)
    }  
    p_Ist = ifelse((new_Ist <0 | Is[it,]==0), 0, new_Ist / Is[it, ])
    
    
    ## set up a transition matrix A
    nt = rbind(S[it, ], St[it,], E[it, ], Et[it, ], A[it, ], At[it,], Im[it,], Imt[it,], Is[it,], Ist[it,], R[it,], incid_deaths[it,])
    
    
    # create a list of empty transition matrices for each age cat
    TM_list = lapply(1:Ncomp, matrix, data= NA, nrow=dim(nt)[1], ncol=dim(nt)[1])
    for (k in 1:Ncomp){
      Tm_a = TM_list[[k]]
      
      # transitions out of S compartment
      Tm_a[1,] = c(max(0,1-p_St[k]-t(foi_prob[k])), p_St[k], t(foi_prob[k]), 0, 0, 0, 0, 0, 0, 0, 0, 0)
      # transitions out of St compartment
      Tm_a[2,] = c(0, max(0,1-t(foi_prob_St[k])), t(foi_prob_St[k]), 0, 0, 0, 0, 0, 0, 0, 0, 0)
      # transitions out of E compartment
      Tm_a[3,] = c(0, 0, max(0,1-p_Et[k]-exposed_prob[k]), p_Et[k], exposed_prob[k]*p_asym[k], 0, exposed_prob[k]*p_mild[k], 0, exposed_prob[k]*p_severe[k], 0, 0, 0)
      # transitions out of Et compartment
      Tm_a[4,] = c(0, 0, 0, max(0,1-inf_prob_et[k]-inf_prob_t[k]), inf_prob_et[k]*p_asym[k], 0, inf_prob_et[k]*p_mild[k], 0, inf_prob_et[k]*p_severe[k], 0, inf_prob_t[k], 0)
      # transitions out of Ia compartment
      Tm_a[5,] = c(0, 0, 0, 0, max(0,1-p_Iat[k]-inf_prob[k]), p_Iat[k], 0, 0, 0, 0, inf_prob[k], 0)
      # transitions out of Iat compartment
      Tm_a[6,] = c(0, 0, 0, 0, 0, max(0,1-inf_prob_t[k]), 0, 0, 0, 0, inf_prob_t[k], 0)
      # transitions out of Im compartment
      Tm_a[7,] = c(0, 0, 0, 0, 0, 0, max(0,1-p_Imt[k]-inf_prob[k]), p_Imt[k], 0, 0, inf_prob[k], 0)
      # transitions out of Imt compartment
      Tm_a[8,] = c(0, 0, 0, 0, 0, 0, 0, max(0,1-inf_prob_t[k]), 0, 0, inf_prob_t[k], 0)
      # transitions out of Is compartment
      Tm_a[9,] = c(0, 0, 0, 0, 0, 0, 0, 0, max(0,1-p_Ist[k]-inf_prob[k]-death_prob_I[k]), p_Ist[k], inf_prob[k], death_prob_I[k])
      # transitions out of Ist compartment
      Tm_a[10,] = c(0, 0, 0, 0, 0, 0, 0, 0, 0, max(0,1-inf_prob_t[k]-death_prob_It[k]), inf_prob_t[k], death_prob_It[k])
      # transitions out of R compartment
      Tm_a[11,] = c(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1-0, 0)
      # transitions out of incid_deaths compartment ---- no movement out - more of a placeholder row to pad out the matrix
      Tm_a[12,] = c(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1)
      
      TM_list[[k]] = t(Tm_a)    ### transpose 
      
    }
    
    
    nt_vec = t(t(as.vector(nt)))
    TM_full = matrix(0, nrow = Ncomp * dim(nt)[1], ncol = Ncomp * dim(nt)[1])
    for (k in 1:Ncomp){
      TM_full[(dim(nt)[1]*(k-1)+1):((dim(nt)[1]*(k-1))+dim(nt)[1]), (dim(nt)[1]*(k-1)+1):((dim(nt)[1]*(k-1))+dim(nt)[1])] = TM_list[[k]]
    }
    
    #### deterministic approach
    if(stoch==FALSE){
      ntp1 = TM_full %*% nt_vec 
      
      
      # create incidence data
      # replace diagonal values with 0s (because that's the people that stay in the same compartment)
      TM_new = TM_full
      diag(TM_new) = 0
      ntp1_new = TM_new %*% nt_vec
      ntp1_new.df =data.frame(ntp1_new)
      # for incid_deaths
      incid_deaths_new = ntp1_new.df %>% filter(row_number() %% dim(nt)[1] == 0)
      # for Ia, extract every 7th column, starting with 5th 
      Ia_new = ntp1_new.df %>%  filter(row_number() %% dim(nt)[1] == 5)
      # for Im
      Im_new = ntp1_new.df %>%  filter(row_number() %% dim(nt)[1] == 7)
      # for Is
      Is_new = ntp1_new.df %>%  filter(row_number() %% dim(nt)[1] == 9)
      # for plasma
      I_plasma_st = ntp1_new.df %>%  filter(row_number() %% dim(nt)[1] == 2) 
      I_plasma_et = ntp1_new.df %>%  filter(row_number() %% dim(nt)[1] == 4)
      I_plasma_iat = ntp1_new.df %>%  filter(row_number() %% dim(nt)[1] == 6)
      I_plasma_imt = ntp1_new.df %>%  filter(row_number() %% dim(nt)[1] == 8)
      I_plasma_ist = ntp1_new.df %>%  filter(row_number() %% dim(nt)[1] == 10)
      I_plasma = I_plasma_st + I_plasma_et + I_plasma_iat + I_plasma_imt + I_plasma_ist
      
    }
    
    
    ##### Stochastic formulation
    
    
    if(stoch==TRUE){
      # do multinomial draws
      TmN_i = matrix(NA, nrow = nrow(TM_full), ncol = ncol(TM_full))
      
      for (k in 1:(nrow(TM_full))){
        size = nt_vec[k]
        TmN_i[,k] = rmultinom(1, size, prob = TM_full[,k])
      }
      ntp1 = rowSums(TmN_i)    
      
      
      # create incidence data
      # replace diagonal values with 0s (because that's the people that stay in the same compartment)
      TM_new = TmN_i
      diag(TM_new) = 0
      ntp1_new = rowSums(TM_new)
      ntp1_new.df =data.frame(ntp1_new)
      # for incid_deaths
      incid_deaths_new = ntp1_new.df %>% filter(row_number() %% dim(nt)[1] == 0)
      # for Ia, extract every 7th column, starting with 5th 
      Ia_new = ntp1_new.df %>%  filter(row_number() %% dim(nt)[1] == 5)
      # for Im
      Im_new = ntp1_new.df %>%  filter(row_number() %% dim(nt)[1] == 7)
      # for Is
      Is_new = ntp1_new.df %>%  filter(row_number() %% dim(nt)[1] == 9)
      # for plasma
      I_plasma_st = ntp1_new.df %>%  filter(row_number() %% dim(nt)[1] == 2) 
      I_plasma_et = ntp1_new.df %>%  filter(row_number() %% dim(nt)[1] == 4)
      I_plasma_iat = ntp1_new.df %>%  filter(row_number() %% dim(nt)[1] == 6)
      I_plasma_imt = ntp1_new.df %>%  filter(row_number() %% dim(nt)[1] == 8)
      I_plasma_ist = ntp1_new.df %>%  filter(row_number() %% dim(nt)[1] == 10)
      I_plasma = I_plasma_st + I_plasma_et + I_plasma_iat + I_plasma_imt + I_plasma_ist
    }
    
    
    
    # update the plasma compartment
    # number of recovered individuals
    rec = round(sum(ntp1[seq(11, length(ntp1), dim(nt)[1])]))
    P[it+1,] = P[it,] - sum(I_plasma) + rbinom(n = 1, size = rec, prob = p_give*rate_p)
    
    # convert to a nice format for output
    temp=matrix(ntp1, ncol = Ncomp, byrow=FALSE)
    temp_vec = as.vector(t(temp))
    # drop the incid_deaths from temp_vec
    temp_vec = temp_vec[1:(Ncomp * (dim(nt)[1]-1))]
    out[it+1,] = c(temp_vec, t(incid_deaths_new), t(Ia_new), t(Im_new), t(Is_new), t(I_plasma), P[it+1,])
    
    
    S[it+1,] = out[it+1, 1:Ncomp] 
    St[it+1,] = out[it+1, (Ncomp+1):(2*Ncomp)]
    E[it+1,] = out[it+1, (2*Ncomp+1):(3*Ncomp)] 
    Et[it+1,] = out[it+1, (3*Ncomp+1):(4*Ncomp)]
    A[it+1,] = out[it+1, (4*Ncomp+1):(5*Ncomp)]
    At[it+1,] = out[it+1, (5*Ncomp+1):(6*Ncomp)]
    Im[it+1,] = out[it+1, (6*Ncomp+1):(7*Ncomp)]
    Imt[it+1,] = out[it+1, (7*Ncomp+1):(8*Ncomp)]
    Is[it+1,] = out[it+1, (8*Ncomp+1):(9*Ncomp)]
    Ist[it+1,] = out[it+1, (9*Ncomp+1):(10*Ncomp)]
    R[it+1,] =  out[it+1, (10*Ncomp+1):(11*Ncomp)]
    
    # incidence
    incid_deaths[it+1,] = out[it+1, (11*Ncomp+1):(12*Ncomp)]
    incid_A[it+1,] = out[it+1, (12*Ncomp+1):(13*Ncomp)]
    incid_Im[it+1,] = out[it+1, (13*Ncomp+1):(14*Ncomp)]
    incid_Is[it+1,] = out[it+1, (14*Ncomp+1):(15*Ncomp)]
    incid_plasma[it+1,] = out[it+1, (15*Ncomp+1):(16*Ncomp)]
    
    P[it+1,] = out[it+1, (16*Ncomp+1)]
  }
  
  
  
  
  out2 = data.frame(cbind(time, S, St, E, Et, A, At, Im, Imt, Is, Ist, R, incid_deaths, incid_A, incid_Im, incid_Is, incid_plasma, P))
  names(out2) = c("time", names(ICs), "plasma_units")
  
  return(out2) 
}  

```



```{r, echo=FALSE}


multiple_runs_age <- function(IC = InCs, stoch_value = TRUE, Ncomp2 = Ncomp, plasma_p = plasma_params, paramt = parameters, SIA_r = SIA_rates, nsims = 100){
  

  all_sim <- matrix(NA,1,(length(IC))+2+1) 
  
  
  colnames(all_sim) <- c('run_index', 'time',                         
                         names(IC), 'plasma_units') 
  for(n in 1:nsims){    
    ## run the simulation one time    
  
  single.sim =seir_step_age(stoch = stoch_value, stoch.init = FALSE, Ncomp = Ncomp2, ICs = IC, sd.dw = 0.00, 
                     params = paramt, plasma = plasma_p,
                     SIA_r = SIA_r,
                     init.min = 10, init.max = 100 ) 

    #add on a value for the run_index (simulation number)    
    run_index = rep(n, nrow(single.sim))    
    single.sim <- cbind(run_index, single.sim)    
    all_sim <- rbind(all_sim, single.sim)  
  }
  
  
  all_sim <- all_sim[-1,]
  
  # create cumulative vars
  
  xx <- all_sim %>% select(starts_with("incid_A")) %>% rowSums()
  all_sim = cbind(all_sim, incid_A=xx)
  
    xx <- all_sim %>% select(starts_with("incid_Im")) %>% rowSums()
  all_sim = cbind(all_sim, incid_Im=xx)
  
    xx <- all_sim %>% select(starts_with("incid_Is")) %>% rowSums()
  all_sim = cbind(all_sim, incid_Is=xx)
  
  xx <- all_sim %>% select(starts_with("incid_deaths")) %>% rowSums()
  all_sim = cbind(all_sim, incid_deaths=xx)
  
  all_sim <- all_sim %>% 
    arrange(run_index, time) %>%
    group_by(run_index) %>%
    mutate(cum_infA = cumsum(incid_A),
           cum_infM = cumsum(incid_Im),
           cum_infS = cumsum(incid_Is),
           incid_I = incid_A + incid_Im + incid_Is,
           cum_inf = cum_infA + cum_infM + cum_infS,
           cum_deaths = cumsum(incid_deaths)
    ) %>%
    ungroup()

  return(all_sim)
}



```




## Scenarios

Scenario 1: no plasma is administered



```{r, echo=FALSE}
pop_data = pop


  # 2% death rate data from CDC 
  symptomatic_2<- c(123,705,429,838,354,429,429)
  hosp_2<- c(3.08,146.64,121.41,307.05,224.5,121.41,121.41)
  ICU_2<-c(0,29.61,44.62,124.94,106.86,44.62,44.62)
  dead_ICU_2<- c(0, 0.58,1.465,11.095,16.435,1.465,1.465)
  
  num_sym = symptomatic_2
  p_hosp = hosp_2 / symptomatic_2
  
  prop_sym = num_sym / 1000
  p_asym = 1 - prop_sym    # proportion asymptomatic
  p_severe = prop_sym * p_hosp # proportion severe
  p_mild = prop_sym * (1-p_hosp) # proportion mild
  
  p_death = dead_ICU_2 / hosp_2
  
X = setup_seir_age(c_scale_vec=1, prop_sym = prop_sym, p_hosp = p_severe, hcw.mix="45,55", hml.mix="45,55", 
                          pop = pop_data, age.limits = c(0, 20, 45, 55, 75))

Ncomp = X$Ncomp
InCs = X$ICs
W = X$W
C = X$C

N = pop
R0 = 2.5
gamma = rep(1 / 6.5, Ncomp)
sigma = rep(1 / 5.2, Ncomp)
time_max = 400
delta.t = 1
time = seq(0, time_max, delta.t)
v = 0  ### death rate
mu = 0 ### birth rate
v_I = p_death / (3* 7) ### mortality from infection; median time to death is assumed to be 3 weeks (from WHO CHINA joint mission report)


#plasma parameters --- first, set all the treatment rates to 0
#r_st = c(0, 0)
#ef_st = 0.7
#r_et = c(0, 0)
#ef_et = 0.7
#r_it = 0
#ef_it = 0.7
gamma_t = rep(1 / 4, Ncomp)
v_It = v_I / 2
ef_est = 0.5
prop_ef = 0.7
prop_eti = 0.1

p0 = 2000   # number of units of plasma available at day 1
p_s = rep(0, Ncomp)     # proportion of plasma used allocated to susceptible 
p_e = rep(0, Ncomp)   # proportion of plasma used allocated to exposed
p_ia = rep(0, Ncomp)   # proportion of plasma used allocated for treatment of infected asymptomatic
p_im = rep(0, Ncomp)  # proportion of plasma used allocated for treatment of infected mild
p_is = rep(0, Ncomp) # proportion of plasma used allocated for treatment of infected severe
p_use = 0   # proportion of available plasma that's used 
rate_p = 3.5 / 14 # rate at which recovered give units of blood; assume each person gives 3.5 units; 14 days after recovery
p_give = 0.1 # proportion of recovered people that donate plasma


parameters <- list(N=N, W=W, beta = R0 * gamma, gamma=gamma, sigma=sigma, time=time, delta.t=delta.t, v = v, mu = mu, v_I = v_I, p_asym = p_asym, p_mild = p_mild, p_severe = p_severe,
                   C = C, W = W)

plasma_params <- list(#r_st = r_st, 
                      #ef_st = ef_st, 
                      #r_et = r_et, #ef_et = ef_et, 
                      #r_it = r_it, #ef_it = ef_it, 
                      gamma_t = gamma_t, v_It = v_It,
                      ef_est = ef_est, prop_ef = prop_ef, 
                      prop_eti = prop_eti,
                      p0 = p0, p_s = p_s, p_e = p_e, 
                      p_ia = p_ia, p_im = p_im, p_is = p_is,
                      p_use = p_use, rate_p = rate_p, p_give = p_give)


# set up a mass campaign
# initialize a time vector

t_SIA_s = 1   # time when SIA for susceptibles is administered
val_SIA_s = rep(0, Ncomp) # number of people that are vaccinated during the campaign
blank = matrix(0, nrow=length(time), ncol = Ncomp)
SIA_s = blank
SIA_s[t_SIA_s, ] = val_SIA_s

t_SIA_e = 1
val_SIA_e = rep(0, Ncomp)
SIA_e = blank
SIA_e[t_SIA_e, ] = val_SIA_e

t_SIA_ia = 1
val_SIA_ia = rep(0, Ncomp)
SIA_ia = blank
SIA_ia[t_SIA_ia, ] = val_SIA_ia

t_SIA_im = 1
val_SIA_im = rep(0, Ncomp)
SIA_im = blank
SIA_im[t_SIA_im, ] = val_SIA_im

t_SIA_is = 1
val_SIA_is = rep(0, Ncomp)
SIA_is = blank
SIA_is[t_SIA_is, ] = val_SIA_is


SIA_rates <- list(SIA_s = SIA_s, SIA_e = SIA_e, SIA_ia = SIA_ia, SIA_im = SIA_im, SIA_is = SIA_is)
```

Run single simulations - deterministic and stochastic
```{r, echo=FALSE}
single.sim =seir_step_age(stoch = TRUE, stoch.init = FALSE, Ncomp = Ncomp, ICs = InCs, sd.dw = 0.00, 
                     params = parameters, plasma = plasma_params,
                     SIA_r = SIA_rates,
                     init.min = 10, init.max = 100 ) 

single.sim_det =seir_step_age(stoch = FALSE, stoch.init = FALSE, Ncomp = Ncomp, ICs = InCs, sd.dw = 0.00, 
                     params = parameters, plasma = plasma_params,
                     SIA_r = SIA_rates,
                     init.min = 10, init.max = 100 ) 


```

```{r, echo=FALSE}
# plot deterministic number of infections and deaths
single.sim_det = single.sim_det %>% mutate(incidI = A1 + A2 + A3 + A4 + A5 + A6 + A7 +
                            Im1 + Im2 + Im3 + Im4 + Im5 + Im6 + Im7 + 
                            Is1 + Is2 + Is3 + Is4 + Is5 + Is6 + Is7,
                            incid_deaths = incid_deaths1+incid_deaths2 + incid_deaths3 + incid_deaths4 + 
                              incid_deaths5 + incid_deaths6 + incid_deaths7)
single.sim_det %>% ggplot(aes(time,incidI))+geom_line()+ggtitle("Deterministic model, Daily infectious cases, all groups")
 single.sim_det %>% ggplot(aes(time,incid_deaths))+geom_line()+ggtitle("Deterministic model, Daily deaths, all groups")
 
```
```{r, echo=FALSE}
# plot stochastic number of infections and deaths
single.sim_sto = single.sim %>% mutate(incidI = A1 + A2 + A3 + A4 + A5 + A6 + A7 +
                            Im1 + Im2 + Im3 + Im4 + Im5 + Im6 + Im7 + 
                            Is1 + Is2 + Is3 + Is4 + Is5 + Is6 + Is7,
                            incid_deaths = incid_deaths1+incid_deaths2 + incid_deaths3 + incid_deaths4 + 
                              incid_deaths5 + incid_deaths6 + incid_deaths7)
single.sim_sto %>% ggplot(aes(time,incidI))+geom_line()+ggtitle("Stochastic model, Daily infectious cases, all groups")
 single.sim_sto %>% ggplot(aes(time,incid_deaths))+geom_line()+ggtitle("Stochastic model, Daily deaths, all groups")
 
```


Now run multiple simulations for the stochastic formulation
```{r, echo=FALSE}

num_sims = 100
all_sim_run1 = suppressWarnings(multiple_runs_age(nsims = num_sims, stoch = TRUE))
```

```{r, echo=FALSE, fig.width=9}
# Plot new infections and deaths 
summ_days_run1 = all_sim_run1 %>% drop_na() %>% group_by(time) %>%
summarise(mean_inf = mean(incid_I, na.rm=TRUE),
ll_inf= quantile(incid_I, prob=c(.025), na.rm=TRUE),
ul_inf = quantile(incid_I, prob=c(.975), na.rm = TRUE),
mean_deaths = mean(incid_deaths, na.rm=TRUE),
ll_deaths = quantile(incid_deaths, prob = c(.025), na.rm=TRUE),
ul_deaths = quantile(incid_deaths, prob = c(.975), na.rm=TRUE)
)

colors = c("New infections" = "blue")
new_inf_plot<-ggplot(data=summ_days_run1, aes(x=time)) +
geom_line(aes(y = mean_inf, color = "New infections")) +
geom_ribbon(aes(ymin=ll_inf, ymax=ul_inf), fill="blue", linetype=2, alpha=0.1) +
ggtitle("New infections") +   theme_classic() +
scale_color_manual(values = colors)+
labs(y = "Daily cases", x = "Day", color="Legend")
#new_inf_plot


colors = c("New deaths" = "blue")
new_deaths_plot<-ggplot(data=summ_days_run1, aes(x=time)) +
geom_line(aes(y = mean_deaths, color = "New deaths")) +
geom_ribbon(aes(ymin=ll_deaths, ymax=ul_deaths), fill="blue", linetype=2, alpha=0.1) +
ggtitle("New deaths") +   theme_classic() +
scale_color_manual(values = colors)+
labs(y = "Daily cases", x = "Day", color="Legend")
#new_deaths_plot

gridExtra::grid.arrange(new_inf_plot, new_deaths_plot, nrow = 1)
```


<!-- # Look at final size, severe infections, and deaths from `r num_sims` simulations --> 

```{r, echo=FALSE}
summ_ <- all_sim_run1 %>% group_by(run_index) %>% 
  summarise(final_size = max(cum_inf, na.rm=TRUE),
            final_deaths = max(cum_deaths, na.rm=TRUE),
            final_plasma = max(cumsum(incid_plasma1)+cumsum(incid_plasma2)+cumsum(incid_plasma3)+
                                 cumsum(incid_plasma4)+cumsum(incid_plasma5)+cumsum(incid_plasma6)+
                                 cumsum(incid_plasma7), na.rm=TRUE))

final_size_all <- summ_ %>%
  summarise(mean = mean(final_size, na.rm=TRUE),
            median = median(final_size, na.rm=TRUE),
            ll = quantile(final_size, prob=c(.025)),
            ul = quantile(final_size, prob=c(.975)))

final_deaths_all <- summ_ %>%
  summarise(mean = mean(final_deaths, na.rm=TRUE),
            median = median(final_deaths, na.rm=TRUE),
            ll = quantile(final_deaths, prob=c(.025)),
            ul = quantile(final_deaths, prob=c(.975)))

final_plasma_all <- summ_ %>%
  summarise(mean = mean(final_plasma, na.rm=TRUE),
            median = median(final_plasma, na.rm=TRUE),
            ll = quantile(final_plasma, prob=c(.025)),
            ul = quantile(final_plasma, prob=c(.975)))

# make a table
table = data.frame(t(round(final_size_all)), t(round(final_deaths_all)))
rownames(table) = c("Mean", "Median", "lower 95% CI limit", "upper 95% CI limit")
colnames(table) = c("Final infection size", "Final deaths from COVID")
table %>% kable() %>% kable_styling(c("basic", "scale_down"))

```







Scenario 2 - assume we are only treating individuals in I severe; (100% of available plasma goes to severe infectious people - 0.1 in each of first 2 groups, 0.2 in last 3 groups, and 0.2 to healthcare workers)
```{r, echo=FALSE}
#plasma parameters --- update proportion of plasma only


p0 = 2000   # number of units of plasma available at day 1
p_s = rep(0, Ncomp)     # proportion of plasma used allocated to susceptible 
p_e = rep(0, Ncomp)   # proportion of plasma used allocated to exposed
p_ia = rep(0, Ncomp)   # proportion of plasma used allocated for treatment of infected asymptomatic
p_im = rep(0, Ncomp)  # proportion of plasma used allocated for treatment of infected mild
p_is = c(0.1, 0.1, 0.2, 0.2, 0.2, 0.2, 0) # proportion of plasma used allocated for treatment of infected severe
p_use = 1   # proportion of available plasma that's used 
rate_p = 3.5 / 14 # rate at which recovered give units of blood; assume each person gives 3.5 units; 14 days after recovery
p_give = 0.1 # proportion of recovered people that donate plasma
 
plasma_params <- list(#r_st = r_st, 
                      #ef_st = ef_st, 
                      #r_et = r_et, #ef_et = ef_et, 
                      #r_it = r_it, #ef_it = ef_it, 
                      gamma_t = gamma_t, v_It = v_It,
                      ef_est = ef_est, prop_ef = prop_ef, 
                      prop_eti = prop_eti,
                      p0 = p0, p_s = p_s, p_e = p_e, 
                      p_ia = p_ia, p_im = p_im, p_is = p_is,
                      p_use = p_use, rate_p = rate_p, p_give = p_give)

all_sim_run2 = suppressWarnings(multiple_runs_age(nsims = num_sims, plasma_p = plasma_params))

```


```{r, echo=FALSE, fig.width=9}
# Plot new infections and deaths 
summ_days_run2 = all_sim_run2 %>% drop_na() %>% group_by(time) %>%
summarise(mean_inf = mean(incid_I, na.rm=TRUE),
ll_inf= quantile(incid_I, prob=c(.025)),
ul_inf = quantile(incid_I, prob=c(.975)),
mean_deaths = mean(incid_deaths, na.rm=TRUE),
ll_deaths = quantile(incid_deaths, prob = c(.025)),
ul_deaths = quantile(incid_deaths, prob = c(.975))
)

colors = c("New infections" = "blue")
new_inf_plot2<-ggplot(data=summ_days_run2, aes(x=time)) +
geom_line(aes(y = mean_inf, color = "New infections")) +
geom_ribbon(aes(ymin=ll_inf, ymax=ul_inf), fill="blue", linetype=2, alpha=0.1) +
ggtitle("New infections") +   theme_classic() +
scale_color_manual(values = colors)+
labs(y = "Daily cases", x = "Day", color="Legend")
#new_inf_plot2


colors = c("New deaths" = "blue")
new_deaths_plot2<-ggplot(data=summ_days_run2, aes(x=time)) +
geom_line(aes(y = mean_deaths, color = "New deaths")) +
geom_ribbon(aes(ymin=ll_deaths, ymax=ul_deaths), fill="blue", linetype=2, alpha=0.1) +
ggtitle("New deaths") +   theme_classic() +
scale_color_manual(values = colors)+
labs(y = "Daily cases", x = "Day", color="Legend")
#new_deaths_plot2

gridExtra::grid.arrange(new_inf_plot2, new_deaths_plot2, nrow = 1)
```

```{r, echo=FALSE}
summ_2 <- all_sim_run2 %>% group_by(run_index) %>% 
  summarise(final_size = max(cum_inf, na.rm=TRUE),
            final_deaths = max(cum_deaths, na.rm=TRUE),
            final_plasma = max(cumsum(incid_plasma1)+cumsum(incid_plasma2)+cumsum(incid_plasma3)+
                                 cumsum(incid_plasma4)+cumsum(incid_plasma5)+cumsum(incid_plasma6)+
                                 cumsum(incid_plasma7), na.rm=TRUE))

final_size_all_2 <- summ_2 %>%
  summarise(mean = mean(final_size, na.rm=TRUE),
            median = median(final_size, na.rm=TRUE),
            ll = quantile(final_size, prob=c(.025)),
            ul = quantile(final_size, prob=c(.975)))

final_deaths_all_2 <- summ_2 %>%
  summarise(mean = mean(final_deaths, na.rm=TRUE),
            median = median(final_deaths, na.rm=TRUE),
            ll = quantile(final_deaths, prob=c(.025)),
            ul = quantile(final_deaths, prob=c(.975)))

final_plasma_all_2 <- summ_2 %>%
  summarise(mean = mean(final_plasma, na.rm=TRUE),
            median = median(final_plasma, na.rm=TRUE),
            ll = quantile(final_plasma, prob=c(.025)),
            ul = quantile(final_plasma, prob=c(.975)))

```




Scenario 3 - assume we are only giving plasma only to susceptible healthworkers (2,000 units of plasma available at t=0)


```{r, echo=FALSE}
#plasma parameters --- update S only


p0 = 2000   # number of units of plasma available at day 1
p_s = c(0, 0, 0, 0, 0, 1, 0)    # proportion of plasma used allocated to susceptible 
p_e = rep(0, Ncomp)   # proportion of plasma used allocated to exposed
p_ia = rep(0, Ncomp)   # proportion of plasma used allocated for treatment of infected asymptomatic
p_im = rep(0, Ncomp)  # proportion of plasma used allocated for treatment of infected mild
p_is = rep(0, Ncomp) # proportion of plasma used allocated for treatment of infected severe
p_use = 1   # proportion of available plasma that's used 
rate_p = 3.5 / 14 # rate at which recovered give units of blood; assume each person gives 3.5 units; 14 days after recovery
p_give = 0.1 # proportion of recovered people that donate plasma
 

plasma_params <- list(#r_st = r_st, 
                      #ef_st = ef_st, 
                      #r_et = r_et, #ef_et = ef_et, 
                      #r_it = r_it, #ef_it = ef_it, 
                      gamma_t = gamma_t, v_It = v_It,
                      ef_est = ef_est, prop_ef = prop_ef, 
                      prop_eti = prop_eti,
                      p0 = p0, p_s = p_s, p_e = p_e, 
                      p_ia = p_ia, p_im = p_im, p_is = p_is,
                      p_use = p_use, rate_p = rate_p, p_give = p_give)




all_sim_run3 = suppressWarnings(multiple_runs_age(nsims = num_sims, plasma_p = plasma_params, paramt = parameters))

```

```{r, echo=FALSE, fig.width=9}
# Plot new infections and deaths 
summ_days_run3 = all_sim_run3 %>% drop_na() %>% group_by(time) %>%
summarise(mean_inf = mean(incid_I, na.rm=TRUE),
ll_inf= quantile(incid_I, prob=c(.025)),
ul_inf = quantile(incid_I, prob=c(.975)),
mean_deaths = mean(incid_deaths, na.rm=TRUE),
ll_deaths = quantile(incid_deaths, prob = c(.025)),
ul_deaths = quantile(incid_deaths, prob = c(.975))
)

colors = c("New infections" = "blue")
new_inf_plot3<-ggplot(data=summ_days_run3, aes(x=time)) +
geom_line(aes(y = mean_inf, color = "New infections")) +
geom_ribbon(aes(ymin=ll_inf, ymax=ul_inf), fill="blue", linetype=2, alpha=0.1) +
ggtitle("New infections") +   theme_classic() +
scale_color_manual(values = colors)+
labs(y = "Daily cases", x = "Day", color="Legend")
#new_inf_plot2


colors = c("New deaths" = "blue")
new_deaths_plot3<-ggplot(data=summ_days_run3, aes(x=time)) +
geom_line(aes(y = mean_deaths, color = "New deaths")) +
geom_ribbon(aes(ymin=ll_deaths, ymax=ul_deaths), fill="blue", linetype=2, alpha=0.1) +
ggtitle("New deaths") +   theme_classic() +
scale_color_manual(values = colors)+
labs(y = "Daily cases", x = "Day", color="Legend")
#new_deaths_plot2

gridExtra::grid.arrange(new_inf_plot3, new_deaths_plot3, nrow = 1)
```

```{r, echo=FALSE}
summ_3 <- all_sim_run3 %>% group_by(run_index) %>% 
  summarise(final_size = max(cum_inf, na.rm=TRUE),
            final_deaths = max(cum_deaths, na.rm=TRUE),
           final_plasma = max(cumsum(incid_plasma1)+cumsum(incid_plasma2)+cumsum(incid_plasma3)+
                                 cumsum(incid_plasma4)+cumsum(incid_plasma5)+cumsum(incid_plasma6)+
                                 cumsum(incid_plasma7), na.rm=TRUE))


final_size_all_3 <- summ_3 %>%
  summarise(mean = mean(final_size, na.rm=TRUE),
            median = median(final_size, na.rm=TRUE),
            ll = quantile(final_size, prob=c(.025)),
            ul = quantile(final_size, prob=c(.975)))

final_deaths_all_3 <- summ_3 %>%
  summarise(mean = mean(final_deaths, na.rm=TRUE),
            median = median(final_deaths, na.rm=TRUE),
            ll = quantile(final_deaths, prob=c(.025)),
            ul = quantile(final_deaths, prob=c(.975)))

final_plasma_all_3 <- summ_3 %>%
  summarise(mean = mean(final_plasma, na.rm=TRUE),
            median = median(final_plasma, na.rm=TRUE),
            ll = quantile(final_plasma, prob=c(.025)),
            ul = quantile(final_plasma, prob=c(.975)))


# make a combined table
table = data.frame(t(round(final_size_all)), t(round(final_deaths_all)), t(round(final_plasma_all)), 
                   t(round(final_size_all_2)), t(round(final_deaths_all_2)), t(round(final_plasma_all_2)),
                   t(round(final_size_all_3)), t(round(final_deaths_all_3)), t(round(final_plasma_all_3)))
rownames(table) = c("Mean", "Median", "lower 95% CI limit", "upper 95% CI limit")
colnames(table) = c("Final infection size", "Final deaths from COVID", "Number receiving plasma",
                    "Final infection size", "Final deaths from COVID", "Number receiving plasma",
                    "Final infection size", "Final deaths from COVID", "Number receiving plasma")
table %>% kable() %>% kable_styling(c("basic", "scale_down")) %>%
  add_header_above(c(" " = 1, "Scenario 1" = 3, "Scenario 2" = 3, "Scenario 3" = 3)) %>%
  footnote(general = "Scenario 1 = no plasma intervention; \n 
           Scenario 2 = plasma treatment to infectious compartment only; \n
           Scenario 3 = plasma treatment to susceptible health workers only")

```


```{r, echo=FALSE, fig.width = 9}
# combine the scenarios on a plot

colors = c("Scenario 1" = "blue",
           "Scenario 2" = "red", 
           "Scenario 3" = "green")
new_inf_plot_combo<-ggplot(data = NULL, aes(x=time)) + 
geom_line(data = summ_days_run1, aes(y = mean_inf, color = "Scenario 1")) +
geom_ribbon(data = summ_days_run1, aes(ymin=ll_inf, ymax=ul_inf), fill="blue", linetype=2, alpha=0.1) +
  geom_line(data = summ_days_run2, aes(y = mean_inf, color = "Scenario 2")) +
geom_ribbon(data = summ_days_run2, aes(ymin=ll_inf, ymax=ul_inf), fill="red", linetype=2, alpha=0.1) +
    geom_line(data = summ_days_run3, aes(y = mean_inf, color = "Scenario 3")) +
geom_ribbon(data = summ_days_run3, aes(ymin=ll_inf, ymax=ul_inf), fill="green", linetype=2, alpha=0.1) +
ggtitle("New infections") +   theme_classic() +
scale_color_manual(values = colors)+
labs(y = "Daily cases", x = "Day", color="Legend")
#new_inf_plot_combo


new_deaths_plot_combo<-ggplot(data=NULL, aes(x=time)) +
geom_line(data = summ_days_run1, aes(y = mean_deaths, color = "Scenario 1")) +
geom_ribbon(data = summ_days_run1, aes(ymin=ll_deaths, ymax=ul_deaths), fill="blue", linetype=2, alpha=0.1) +
geom_line(data = summ_days_run2, aes(y = mean_deaths, color = "Scenario 2")) +
geom_ribbon(data = summ_days_run2, aes(ymin=ll_deaths, ymax=ul_deaths), fill="red", linetype=2, alpha=0.1) + 
geom_line(data = summ_days_run3, aes(y = mean_deaths, color = "Scenario 3")) +
geom_ribbon(data = summ_days_run3, aes(ymin=ll_deaths, ymax=ul_deaths), fill="green", linetype=2, alpha=0.1) +
ggtitle("New deaths") +   theme_classic() +
scale_color_manual(values = colors)+
labs(y = "Daily cases", x = "Day", color="Legend")

gridExtra::grid.arrange(new_inf_plot_combo, new_deaths_plot_combo, nrow = 1)

```

Alternative scenario ---- all sorts of infected folks (including asymptomatic and mild), 2,000 units of plasma available
```{r, echo=FALSE}
#plasma parameters --- update proportion of plasma only


p0 = 2000   # number of units of plasma available at day 1
p_s = rep(0, Ncomp)     # proportion of plasma used allocated to susceptible 
p_e = rep(0, Ncomp)   # proportion of plasma used allocated to exposed
p_ia = c(0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0)   # proportion of plasma used allocated for treatment of infected asymptomatic
p_im = c(0.05, 0.05, 0.05, 0.05, 0.05, 0.1, 0)  # proportion of plasma used allocated for treatment of infected mild
p_is = c(0.05, 0.05, 0.05, 0.05, 0.05, 0.1, 0) # proportion of plasma used allocated for treatment of infected severe
p_use = 1   # proportion of available plasma that's used 
rate_p = 3.5 / 14 # rate at which recovered give units of blood; assume each person gives 3.5 units; 14 days after recovery
p_give = 0.1 # proportion of recovered people that donate plasma
 
plasma_params <- list(#r_st = r_st, 
                      #ef_st = ef_st, 
                      #r_et = r_et, #ef_et = ef_et, 
                      #r_it = r_it, #ef_it = ef_it, 
                      gamma_t = gamma_t, v_It = v_It,
                      ef_est = ef_est, prop_ef = prop_ef, 
                      prop_eti = prop_eti,
                      p0 = p0, p_s = p_s, p_e = p_e, 
                      p_ia = p_ia, p_im = p_im, p_is = p_is,
                      p_use = p_use, rate_p = rate_p, p_give = p_give)

all_sim_run3 = suppressWarnings(multiple_runs_age(nsims = num_sims, plasma_p = plasma_params))

```




```{r, echo=FALSE, fig.width=9}
# Plot new infections and deaths 
summ_days_run3 = all_sim_run3 %>% drop_na() %>% group_by(time) %>%
summarise(mean_inf = mean(incid_I, na.rm=TRUE),
ll_inf= quantile(incid_I, prob=c(.025)),
ul_inf = quantile(incid_I, prob=c(.975)),
mean_deaths = mean(incid_deaths, na.rm=TRUE),
ll_deaths = quantile(incid_deaths, prob = c(.025)),
ul_deaths = quantile(incid_deaths, prob = c(.975))
)

colors = c("New infections" = "blue")
new_inf_plot3<-ggplot(data=summ_days_run3, aes(x=time)) +
geom_line(aes(y = mean_inf, color = "New infections")) +
geom_ribbon(aes(ymin=ll_inf, ymax=ul_inf), fill="blue", linetype=2, alpha=0.1) +
ggtitle("New infections") +   theme_classic() +
scale_color_manual(values = colors)+
labs(y = "Daily cases", x = "Day", color="Legend")
#new_inf_plot2


colors = c("New deaths" = "blue")
new_deaths_plot3<-ggplot(data=summ_days_run3, aes(x=time)) +
geom_line(aes(y = mean_deaths, color = "New deaths")) +
geom_ribbon(aes(ymin=ll_deaths, ymax=ul_deaths), fill="blue", linetype=2, alpha=0.1) +
ggtitle("New deaths") +   theme_classic() +
scale_color_manual(values = colors)+
labs(y = "Daily cases", x = "Day", color="Legend")
#new_deaths_plot2

gridExtra::grid.arrange(new_inf_plot3, new_deaths_plot3, nrow = 1)
```

```{r, echo=FALSE}
summ_3 <- all_sim_run3 %>% group_by(run_index) %>% 
  summarise(final_size = max(cum_inf, na.rm=TRUE),
            final_deaths = max(cum_deaths, na.rm=TRUE),
           final_plasma = max(cumsum(incid_plasma1)+cumsum(incid_plasma2)+cumsum(incid_plasma3)+
                                 cumsum(incid_plasma4)+cumsum(incid_plasma5)+cumsum(incid_plasma6)+
                                 cumsum(incid_plasma7), na.rm=TRUE))


final_size_all_3 <- summ_3 %>%
  summarise(mean = mean(final_size, na.rm=TRUE),
            median = median(final_size, na.rm=TRUE),
            ll = quantile(final_size, prob=c(.025)),
            ul = quantile(final_size, prob=c(.975)))

final_deaths_all_3 <- summ_3 %>%
  summarise(mean = mean(final_deaths, na.rm=TRUE),
            median = median(final_deaths, na.rm=TRUE),
            ll = quantile(final_deaths, prob=c(.025)),
            ul = quantile(final_deaths, prob=c(.975)))

final_plasma_all_3 <- summ_3 %>%
  summarise(mean = mean(final_plasma, na.rm=TRUE),
            median = median(final_plasma, na.rm=TRUE),
            ll = quantile(final_plasma, prob=c(.025)),
            ul = quantile(final_plasma, prob=c(.975)))


# make a table
table = data.frame(t(round(final_size_all_3)), t(round(final_deaths_all_3)))
rownames(table) = c("Mean", "Median", "lower 95% CI limit", "upper 95% CI limit")
colnames(table) = c("Final infection size", "Final deaths from COVID")
table %>% kable() %>% kable_styling(c("basic", "scale_down"))
```


Alternative scenario 3 ---- lots of plasma to susceptibles
```{r, echo=FALSE}
#plasma parameters --- update proportion of plasma only


p0 = 200000   # number of units of plasma available at day 1
p_s = c(0.1, 0.2, 0.2, 0.2, 0.2, 0.1, 0)      # proportion of plasma used allocated to susceptible 
p_e = rep(0, Ncomp)   # proportion of plasma used allocated to exposed
p_ia = rep(0, Ncomp)   # proportion of plasma used allocated for treatment of infected asymptomatic
p_im = rep(0, Ncomp)   # proportion of plasma used allocated for treatment of infected mild
p_is = rep(0, Ncomp)  # proportion of plasma used allocated for treatment of infected severe
p_use = 1   # proportion of available plasma that's used 
rate_p = 3.5 / 14 # rate at which recovered give units of blood; assume each person gives 3.5 units; 14 days after recovery
p_give = 0.1 # proportion of recovered people that donate plasma
 
plasma_params <- list(#r_st = r_st, 
                      #ef_st = ef_st, 
                      #r_et = r_et, #ef_et = ef_et, 
                      #r_it = r_it, #ef_it = ef_it, 
                      gamma_t = gamma_t, v_It = v_It,
                      ef_est = ef_est, prop_ef = prop_ef, 
                      prop_eti = prop_eti,
                      p0 = p0, p_s = p_s, p_e = p_e, 
                      p_ia = p_ia, p_im = p_im, p_is = p_is,
                      p_use = p_use, rate_p = rate_p, p_give = p_give)

all_sim_run3 = suppressWarnings(multiple_runs_age(nsims = num_sims, plasma_p = plasma_params))

```



```{r, echo=FALSE, fig.width=9}
# Plot new infections and deaths 
summ_days_run3 = all_sim_run3 %>% drop_na() %>% group_by(time) %>%
summarise(mean_inf = mean(incid_I, na.rm=TRUE),
ll_inf= quantile(incid_I, prob=c(.025)),
ul_inf = quantile(incid_I, prob=c(.975)),
mean_deaths = mean(incid_deaths, na.rm=TRUE),
ll_deaths = quantile(incid_deaths, prob = c(.025)),
ul_deaths = quantile(incid_deaths, prob = c(.975))
)

colors = c("New infections" = "blue")
new_inf_plot3<-ggplot(data=summ_days_run3, aes(x=time)) +
geom_line(aes(y = mean_inf, color = "New infections")) +
geom_ribbon(aes(ymin=ll_inf, ymax=ul_inf), fill="blue", linetype=2, alpha=0.1) +
ggtitle("New infections") +   theme_classic() +
scale_color_manual(values = colors)+
labs(y = "Daily cases", x = "Day", color="Legend")
#new_inf_plot2


colors = c("New deaths" = "blue")
new_deaths_plot3<-ggplot(data=summ_days_run3, aes(x=time)) +
geom_line(aes(y = mean_deaths, color = "New deaths")) +
geom_ribbon(aes(ymin=ll_deaths, ymax=ul_deaths), fill="blue", linetype=2, alpha=0.1) +
ggtitle("New deaths") +   theme_classic() +
scale_color_manual(values = colors)+
labs(y = "Daily cases", x = "Day", color="Legend")
#new_deaths_plot2

gridExtra::grid.arrange(new_inf_plot3, new_deaths_plot3, nrow = 1)
```

```{r, echo=FALSE}
summ_3 <- all_sim_run3 %>% group_by(run_index) %>% 
  summarise(final_size = max(cum_inf, na.rm=TRUE),
            final_deaths = max(cum_deaths, na.rm=TRUE),
           final_plasma = max(cumsum(incid_plasma1)+cumsum(incid_plasma2)+cumsum(incid_plasma3)+
                                 cumsum(incid_plasma4)+cumsum(incid_plasma5)+cumsum(incid_plasma6)+
                                 cumsum(incid_plasma7), na.rm=TRUE))


final_size_all_3 <- summ_3 %>%
  summarise(mean = mean(final_size, na.rm=TRUE),
            median = median(final_size, na.rm=TRUE),
            ll = quantile(final_size, prob=c(.025)),
            ul = quantile(final_size, prob=c(.975)))

final_deaths_all_3 <- summ_3 %>%
  summarise(mean = mean(final_deaths, na.rm=TRUE),
            median = median(final_deaths, na.rm=TRUE),
            ll = quantile(final_deaths, prob=c(.025)),
            ul = quantile(final_deaths, prob=c(.975)))

final_plasma_all_3 <- summ_3 %>%
  summarise(mean = mean(final_plasma, na.rm=TRUE),
            median = median(final_plasma, na.rm=TRUE),
            ll = quantile(final_plasma, prob=c(.025)),
            ul = quantile(final_plasma, prob=c(.975)))


# make a table
table = data.frame(t(round(final_size_all_3)), t(round(final_deaths_all_3)))
rownames(table) = c("Mean", "Median", "lower 95% CI limit", "upper 95% CI limit")
colnames(table) = c("Final infection size", "Final deaths from COVID")
table %>% kable() %>% kable_styling(c("basic", "scale_down"))
```


Alternative scenario  ---- lots of plasma to infected (200,000 units available at t=0, proportion of plasma assigned to severely infected: 0.1, 0.2, 0.2, 0.2, 0.2, 0.1 to each compartment, respectively)
```{r, echo=FALSE}
#plasma parameters --- update proportion of plasma only


p0 = 200000   # number of units of plasma available at day 1
p_s = rep(0, Ncomp)      # proportion of plasma used allocated to susceptible 
p_e = rep(0, Ncomp)   # proportion of plasma used allocated to exposed
p_ia = rep(0, Ncomp)   # proportion of plasma used allocated for treatment of infected asymptomatic
p_im = rep(0, Ncomp)   # proportion of plasma used allocated for treatment of infected mild
p_is = c(0.1, 0.2, 0.2, 0.2, 0.2, 0.1, 0) # proportion of plasma used allocated for treatment of infected severe
p_use = 1   # proportion of available plasma that's used 
rate_p = 3.5 / 14 # rate at which recovered give units of blood; assume each person gives 3.5 units; 14 days after recovery
p_give = 0.1 # proportion of recovered people that donate plasma
 
plasma_params <- list(#r_st = r_st, 
                      #ef_st = ef_st, 
                      #r_et = r_et, #ef_et = ef_et, 
                      #r_it = r_it, #ef_it = ef_it, 
                      gamma_t = gamma_t, v_It = v_It,
                      ef_est = ef_est, prop_ef = prop_ef, 
                      prop_eti = prop_eti,
                      p0 = p0, p_s = p_s, p_e = p_e, 
                      p_ia = p_ia, p_im = p_im, p_is = p_is,
                      p_use = p_use, rate_p = rate_p, p_give = p_give)

all_sim_run3 = suppressWarnings(multiple_runs_age(nsims = num_sims, plasma_p = plasma_params))

```



```{r, echo=FALSE, fig.width=9}
# Plot new infections and deaths 
summ_days_run3 = all_sim_run3 %>% drop_na() %>% group_by(time) %>%
summarise(mean_inf = mean(incid_I, na.rm=TRUE),
ll_inf= quantile(incid_I, prob=c(.025)),
ul_inf = quantile(incid_I, prob=c(.975)),
mean_deaths = mean(incid_deaths, na.rm=TRUE),
ll_deaths = quantile(incid_deaths, prob = c(.025)),
ul_deaths = quantile(incid_deaths, prob = c(.975))
)

colors = c("New infections" = "blue")
new_inf_plot3<-ggplot(data=summ_days_run3, aes(x=time)) +
geom_line(aes(y = mean_inf, color = "New infections")) +
geom_ribbon(aes(ymin=ll_inf, ymax=ul_inf), fill="blue", linetype=2, alpha=0.1) +
ggtitle("New infections") +   theme_classic() +
scale_color_manual(values = colors)+
labs(y = "Daily cases", x = "Day", color="Legend")
#new_inf_plot2


colors = c("New deaths" = "blue")
new_deaths_plot3<-ggplot(data=summ_days_run3, aes(x=time)) +
geom_line(aes(y = mean_deaths, color = "New deaths")) +
geom_ribbon(aes(ymin=ll_deaths, ymax=ul_deaths), fill="blue", linetype=2, alpha=0.1) +
ggtitle("New deaths") +   theme_classic() +
scale_color_manual(values = colors)+
labs(y = "Daily cases", x = "Day", color="Legend")
#new_deaths_plot2

gridExtra::grid.arrange(new_inf_plot3, new_deaths_plot3, nrow = 1)
```

```{r, echo=FALSE}
summ_3 <- all_sim_run3 %>% group_by(run_index) %>% 
  summarise(final_size = max(cum_inf, na.rm=TRUE),
            final_deaths = max(cum_deaths, na.rm=TRUE),
           final_plasma = max(cumsum(incid_plasma1)+cumsum(incid_plasma2)+cumsum(incid_plasma3)+
                                 cumsum(incid_plasma4)+cumsum(incid_plasma5)+cumsum(incid_plasma6)+
                                 cumsum(incid_plasma7), na.rm=TRUE))


final_size_all_3 <- summ_3 %>%
  summarise(mean = mean(final_size, na.rm=TRUE),
            median = median(final_size, na.rm=TRUE),
            ll = quantile(final_size, prob=c(.025)),
            ul = quantile(final_size, prob=c(.975)))

final_deaths_all_3 <- summ_3 %>%
  summarise(mean = mean(final_deaths, na.rm=TRUE),
            median = median(final_deaths, na.rm=TRUE),
            ll = quantile(final_deaths, prob=c(.025)),
            ul = quantile(final_deaths, prob=c(.975)))

final_plasma_all_3 <- summ_3 %>%
  summarise(mean = mean(final_plasma, na.rm=TRUE),
            median = median(final_plasma, na.rm=TRUE),
            ll = quantile(final_plasma, prob=c(.025)),
            ul = quantile(final_plasma, prob=c(.975)))


# make a table
table = data.frame(t(round(final_size_all_3)), t(round(final_deaths_all_3)))
rownames(table) = c("Mean", "Median", "lower 95% CI limit", "upper 95% CI limit")
colnames(table) = c("Final infection size", "Final deaths from COVID")
table %>% kable() %>% kable_styling(c("basic", "scale_down"))
```



Alternative scenario  ---- plasma to exposed only (2,000 units available at t=0, proportion of plasma assigned to exposed: 0.1, 0.1, 0.2, 0.2, 0.2, 0.2 to each compartment, respectively)
```{r, echo=FALSE}
#plasma parameters --- update proportion of plasma only


p0 = 2000   # number of units of plasma available at day 1
p_s = rep(0, Ncomp)      # proportion of plasma used allocated to susceptible 
p_e = c(0.1, 0.1, 0.2, 0.2, 0.2, 0.2, 0)   # proportion of plasma used allocated to exposed
p_ia = rep(0, Ncomp)   # proportion of plasma used allocated for treatment of infected asymptomatic
p_im = rep(0, Ncomp)   # proportion of plasma used allocated for treatment of infected mild
p_is = rep(0, Ncomp) # proportion of plasma used allocated for treatment of infected severe
p_use = 1   # proportion of available plasma that's used 
rate_p = 3.5 / 14 # rate at which recovered give units of blood; assume each person gives 3.5 units; 14 days after recovery
p_give = 0.1 # proportion of recovered people that donate plasma
 
plasma_params <- list(#r_st = r_st, 
                      #ef_st = ef_st, 
                      #r_et = r_et, #ef_et = ef_et, 
                      #r_it = r_it, #ef_it = ef_it, 
                      gamma_t = gamma_t, v_It = v_It,
                      ef_est = ef_est, prop_ef = prop_ef, 
                      prop_eti = prop_eti,
                      p0 = p0, p_s = p_s, p_e = p_e, 
                      p_ia = p_ia, p_im = p_im, p_is = p_is,
                      p_use = p_use, rate_p = rate_p, p_give = p_give)

all_sim_run3 = suppressWarnings(multiple_runs_age(nsims = num_sims, plasma_p = plasma_params))

```



```{r, echo=FALSE, fig.width=9}
# Plot new infections and deaths 
summ_days_run3 = all_sim_run3 %>% drop_na() %>% group_by(time) %>%
summarise(mean_inf = mean(incid_I, na.rm=TRUE),
ll_inf= quantile(incid_I, prob=c(.025)),
ul_inf = quantile(incid_I, prob=c(.975)),
mean_deaths = mean(incid_deaths, na.rm=TRUE),
ll_deaths = quantile(incid_deaths, prob = c(.025)),
ul_deaths = quantile(incid_deaths, prob = c(.975))
)

colors = c("New infections" = "blue")
new_inf_plot3<-ggplot(data=summ_days_run3, aes(x=time)) +
geom_line(aes(y = mean_inf, color = "New infections")) +
geom_ribbon(aes(ymin=ll_inf, ymax=ul_inf), fill="blue", linetype=2, alpha=0.1) +
ggtitle("New infections") +   theme_classic() +
scale_color_manual(values = colors)+
labs(y = "Daily cases", x = "Day", color="Legend")
#new_inf_plot2


colors = c("New deaths" = "blue")
new_deaths_plot3<-ggplot(data=summ_days_run3, aes(x=time)) +
geom_line(aes(y = mean_deaths, color = "New deaths")) +
geom_ribbon(aes(ymin=ll_deaths, ymax=ul_deaths), fill="blue", linetype=2, alpha=0.1) +
ggtitle("New deaths") +   theme_classic() +
scale_color_manual(values = colors)+
labs(y = "Daily cases", x = "Day", color="Legend")
#new_deaths_plot2

gridExtra::grid.arrange(new_inf_plot3, new_deaths_plot3, nrow = 1)
```

```{r, echo=FALSE}
summ_3 <- all_sim_run3 %>% group_by(run_index) %>% 
  summarise(final_size = max(cum_inf, na.rm=TRUE),
            final_deaths = max(cum_deaths, na.rm=TRUE),
           final_plasma = max(cumsum(incid_plasma1)+cumsum(incid_plasma2)+cumsum(incid_plasma3)+
                                 cumsum(incid_plasma4)+cumsum(incid_plasma5)+cumsum(incid_plasma6)+
                                 cumsum(incid_plasma7), na.rm=TRUE))


final_size_all_3 <- summ_3 %>%
  summarise(mean = mean(final_size, na.rm=TRUE),
            median = median(final_size, na.rm=TRUE),
            ll = quantile(final_size, prob=c(.025)),
            ul = quantile(final_size, prob=c(.975)))

final_deaths_all_3 <- summ_3 %>%
  summarise(mean = mean(final_deaths, na.rm=TRUE),
            median = median(final_deaths, na.rm=TRUE),
            ll = quantile(final_deaths, prob=c(.025)),
            ul = quantile(final_deaths, prob=c(.975)))

final_plasma_all_3 <- summ_3 %>%
  summarise(mean = mean(final_plasma, na.rm=TRUE),
            median = median(final_plasma, na.rm=TRUE),
            ll = quantile(final_plasma, prob=c(.025)),
            ul = quantile(final_plasma, prob=c(.975)))


# make a table
table = data.frame(t(round(final_size_all_3)), t(round(final_deaths_all_3)))
rownames(table) = c("Mean", "Median", "lower 95% CI limit", "upper 95% CI limit")
colnames(table) = c("Final infection size", "Final deaths from COVID")
table %>% kable() %>% kable_styling(c("basic", "scale_down"))
```





